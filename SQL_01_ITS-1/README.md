# База данных для клинических исследований
Аннотация: данный проект позволит тебе познакомиться с понятием базы данных и SQL, созданием базы данных, заполнением её данными и выполнением аналитических запросов. 

## Содержание
1. [Chapter I](#chapter-i) \
   1.1. [Рекомендации к проекту](#рекомендации-к-проекту)
2. [Chapter II](#chapter-ii) \
   2.1. [База данных](#база-данных)
3. [Chapter III](#chapter-iii) \
   3.1. [Задание 1](#часть-1-создание-базы-данных)  
   3.2. [Задание 2](#часть-2-создание-таблиц)  
   3.3. [Задание 3](#часть-3-наполнение-таблиц-данными) \
   3.4  [Задание 4](#часть-4-аналитические-запросы) \
   3.5  [Задание 5](#часть-5-формирование-итогового-отчета)

### Введение

Начался очередной учебный семестр. С внутренней удовлетворенностью от завершения практики в поликлинике №13 города Средние Чебурки, ты сидишь в аудитории университета в ожидании начала новой пары, прокручивая в голове: 

> Просто «Здравствуй», просто «Как дела» \
> Наверное, так начну при встрече я. \
> А пока смотрю издалека, \
> И слёзы не от ветра в глаза, \
> А от счастья снова вернуться сюда...
>> **Стажер (думает про себя)**

Открывается дверь и заходит...

> Этого не может быть... ведь практика завершилась, сейчас исключительно учеба. И всё, что было в поликлинике, осталось в поликлинике, но, кажется, меня это снова преследует... И это тот самый главврач. Есть ощущение, что приключение продолжается. 
>> **Стажер**

> Здравствуйте! Я новый заведующий ~~кафедры~~ кластера. Как приятно видеть знакомые лица. Останетесь после окончания семинара, у меня есть для вас предложение, от которого не сможете отказаться, и оно изменит вашу жизнь.
>> **Главврач**

Спустя пару тот момент Х настал.

> Стажер, учитывая твои успехи на практике, с большой радостью предлагаю тебе поучаствовать в разработке масштабного проекта «Клинические исследования» и применить твои приобретенные навыки языка программирования Python на благо твоей жизни и развития нашей ~~кафедры~~ кластера.
>> **Главврач**

> Но... Мне кажется...
>> **Стажер**

> Мне уже этот мир абсолютно понятен, я здесь ищу только одного: покоя, умиротворения и вот этой гармонии от слияния с бесконечно вечным. 
>> **Стажер (думает про себя)**

> Знаю, ты в восторге. Я вижу твою заинтересованность и горящие глаза. Ты получишь незабываемый опыт! Обещаю.
>> **Главврач**

> Звучит заманчиво! Что нужно делать?
>> **Стажер**

> Первая твоя основная задача — это создать итоговый отчет с базой данных клинических исследований с использованием SQL, отображающий результаты клинических исследований. \
> Все детали первого этапа проекта отправлю тебе на почту. \
> Удачи! 
>> **Главврач**

## Chapter I
### Рекомендации к проекту
Как учиться в «Школе 21»:  
- На протяжении всего курса ты будешь самостоятельно добывать информацию. Пользуйся всеми доступными средствами поиска информации, к примеру, Google и GigaChat. Будь внимателен к источникам информации: проверяй, думай, анализируй, сравнивай. 
- Взаимообучение (P2P, Peer-to-Peer) — это процесс, при котором учащиеся обмениваются знаниями и опытом, выступая одновременно в роли учителей и учеников. Этот подход позволяет учиться не только у преподавателя, но и друг у друга, что способствует более глубокому пониманию материала.
- Не стесняйся просить помощи: вокруг тебя такие же пиры, которые тоже проходят этот путь впервые. Не бойся откликаться на просьбы о помощи. Твой опыт ценен и полезен, смело делись им с другими участниками. 
- Не списывай, а если пользуешься помощью — всегда разбирайся до конца, почему, как и зачем. Иначе твое обучение не будет иметь никакого смысла. 
- Если ты на чем-то застрял, и кажется, что ты уже все перепробовал, но все равно непонятно, куда идти, — просто передохни! Поверь, этот совет помогал многим разработчикам в их работе. Проветрись, перезагрузи голову и, возможно, в следующий раз тебе наконец придет нужное решение!
- Важен не только результат обучения, но и сам процесс. Нужно не просто решить задачу, а понять, КАК ее решить.

Как работать с проектом: 
- Вся работа выполняется на виртуальной машине. Для начала ее нужно настроить, воспользовавшись видео-инструкциями на твой рабочей платформе во вкладке проекта Дополнительные материалы/Supplementary materials. Далее запустить виртуальную машину и продолжать выполнять работу над проектом там.
- Перед выполнением проект необходимо склонировать с GitLab в одноименный репозиторий.
- Все файлы с кодом необходимо создавать в папке src склонированного репозитория.
- После клонирования проекта необходимо создать ветку `develop` и вести разработку в ней. После этого пушить в GitLab также нужно ветку `develop`.
- В директории src представлены следующие файлы для работы `test.py` `answers.py` `trial_statistics.csv`
- В твоей директории не должно быть иных файлов, кроме тех, что обозначены в заданиях. 

Дисклеймер: 
- Наша команда не медики. Если ты будешь видеть в тексте медицинские неточности или ошибки, заранее просим у тебя прощения. Оставляй нам обратную связь, и мы все поправим!
- Иногда повествование ведется в несколько шутливой форме, чтобы не было скучно. Однако, как ты и сам знаешь, юмор и шутки — субъективная вещь. Поэтому если каламбуры в данном тексте, по твоему мнению, попахивают батиным юмором, то, пожалуйста, просто прими это.

## Chapter II
### База данных

Базы данных (БД) нужны для хранения информации. Современные БД позволяют обеспечить надежность хранения, безопасность, удобство доступа к данным, удобство взаимодействия с БД. В большинстве решений используют БД, которые поддерживают язык запросов SQL. Твоя задача — ознакомиться с понятием реляционных баз данных и языком SQL.

После ознакомления необходимо выбрать реляционную БД. Ты можешь использовать популярные системы, такие как PostgreSQL, MySQL, SQLite. Делай выбор в соответствии с твоей заинтересованностью и тем, какие навыки хочешь больше отработать. Например, если тебе хочется научиться настраивать серьезные БД, которые используются в реальных больших проектах, то стоит выбрать PostgreSQL или MySQL. Если не хочется тратить много времени на настройку окружения, а сразу приступить к выполнению заданий, то лучше выбрать БД SQLite. Также ты можешь ознакомиться (но использовать для заданий нельзя) со специализированными для анализа данных БД, такими как Clickhouse или Apache Hive, но это необязательно.

> Комментарий от главврача:\
> Перед тем как приступать к выполнению заданий, тебе нужно развернуть виртуалку. Знаю, что для тебя это будет совершенно новое действие, поэтому я подготовил для тебя видео-инструкции, которые находятся на твой рабочей платформе во вкладке проекта Дополнительные материалы/Supplementary materials.
>> Стажер (внутренним голосом главврача) 

### Задание 1. Создание базы данных
Для начала работы необходимо создать БД и подключиться к ней через любое IDE работы с БД. В качестве IDE рекомендуем DBeaver.
Создать БД SQLite можно в любой IDE для баз данных. 

Для того, чтобы запустить PostgreSQL или MySQL нужно настроить виртуальную машину (ВМ). Можно считать, что виртуальная машина - отдельный сервер с БД, а управление ВМ это управление сервером. Вероятно, postgresql будет установлен по умолчанию на сервере, тогда нужно будет убедиться, что порт БД (5432) открыт для локальной машины.
Если PostgresQL не установлен по умолчанию, можно воспользоваться docker (https://www.docker.com/), который предустановлен на ВМ. Нужно вызвать команду запуска контейнера с БД, например, для постгреса это 
```shell
docker run --name some-postgres -e 
POSTGRES_PASSWORD=mysecretpassword -d -p 5432:5432 
postgres
``` 

Далее, нужно открыть порт 5432 для локальной машины, либо убедиться, что он открыт. postgresql доступен:
user:postgres
password:mysecretpassword
host: localhost
port: 5432
db: postgres

Для MySQL 
```shell
docker run --name some-mysql -e 
MYSQL_ROOT_PASSWORD=mysecretpassword -e 
MYSQL_DATABASE=mydatabase -d -p 3306:3306 mysql
``` 

Открыть или убедиться что открыт порт 3306
user:root
password:mysecretpassword
host: localhost
port: 3306
db: mydatabase

Результатом этого задания является строка подключения к БД в файле `conn.txt`. Пример того, как выглядит строка подключения:

`sqlite:///example.db`

или

`postgresql://username:password@localhost:5432/database`

### Задание 2.Создание таблиц

После создания БД и подключения к ней предполагается работа с данными клинических исследований. В реляционных БД все данные хранятся в виде таблиц, которые могут быть связаны отношениями между собой. Следовательно, тебе предстоит создать 3 таблицы: Пациенты, Исследования, Измерения.

#### Таблица «Пациенты» (patients)

| Поле           | Тип данных  | Описание                        |
|----------------|-------------|---------------------------------|
| patient_id     | INTEGER     | Первичный ключ (Primary Key)    |
| name           | VARCHAR(100)| Имя пациента                    |
| age            | INTEGER     | Возраст пациента                |
| gender         | VARCHAR(10) | Пол пациента (Male/Female)      |
| condition      | VARCHAR(100)| Основное заболевание пациента   |

#### Таблица «Исследования» (trials)

| Поле           | Тип данных  | Описание                        |
|----------------|-------------|---------------------------------|
| trial_id       | INTEGER     | Первичный ключ (Primary Key)    |
| trial_name     | VARCHAR(100)| Название исследования           |
| start_date     | DATE        | Дата начала исследования        |
| end_date       | DATE        | Дата окончания исследования     |

#### Таблица «Измерения» (measurements)

| Поле                | Тип данных  | Описание                                                         |
|---------------------|-------------|------------------------------------------------------------------|
| measurement_id      | INTEGER     | Первичный ключ (Primary Key)                                     |
| patient_id          | INTEGER     | Внешний ключ (Foreign Key), ссылается на `patients.patient_id`   |
| trial_id            | INTEGER     | Внешний ключ (Foreign Key), ссылается на `trials.trial_id`       |
| measurement_date    | DATE        | Дата проведения измерения                                        |
| drug                | VARCHAR(100)| Название препарата (например, «Плацебо» или «Аспирин»)           |
| condition_score     | INTEGER     | Оценка самочувствия пациента по 100-бальной шкале                |


Результат выполнения этого задания — файл с расширением `create.sql` с запросами создания необходимых таблиц.

### Задание 3. Наполнение таблиц данными

Прежде чем приступить к выполнению запросов, нужно наполнить таблицы данными, где их содержимое не принципиально, но желательно, чтобы оно было разнообразным и следовало легенде о клинических испытаниях. \
Вот что должно обязательно быть:
- В каждом исследовании только 2 препарата — «Плацебо» и любой другой;
- condition_score — от 0 до 100;
- Пациентов должно быть больше 20;
- Исследований должно быть больше 5;
- Измерений должно быть больше 200.

Ты можешь заполнить данными любым удобным для тебя способом (даже руками), но рекомендуем написать скрипт на Python или голом SQL, который генерирует случайные данные.

Если ты написал скрипт, то сохрани его в файле с именем `generate_data`.

### Задание 4. Аналитические запросы

С помощью языка SQL можно получать и обрабатывать данные из таблиц, а также получать бесконечные сложные выборки. Это особенно полезный инструмент для анализа данных, в него встроено множество инструментов — группировки, сортировки, партиционирования. Всё это позволяет эффективно работать с большими (и не очень) данными, эффективно формировать отчеты.

В этом задании необходимо выполнить два аналитических запроса и проверить их с помощью предоставленных тестов.

Тесты предоставлены в файле `test.py`, его нужно запускать по мере прохождения заданий для проверки себя. Ознакомься с содержимым файла. Это классический пример работы с БД через ORM в Python. Для аналитических задач обычно не используются ORM, т. к. это ресурсозатратно, но здесь для проверки и для ознакомления применяется ORM. По мере выполнения заданий нужно заполнить файл `answers.py`.

Для запуска `test.py` необходимо установить `python` и через `pip` установить библиотеку `pandas`, `sqlalchemy` и соответствующий драйвер для твоей БД (это можно найти в документации `sqlalchemy` или в интернете).

Запросы:

1. Вывести разницу между средними значениями по плацебо и другим препаратам в каждом исследовании. Отсортировать результаты по дате начала исследования.
2. Посчитать разницу между первым и последним днем для плацебо и реального препарата. Затем вычислить разницу между реальным препаратом и плацебо для каждого эксперимента. Отсортировать результаты по дате начала исследования.

Результат: заполненный файл `answers.py`.

### Задание 5. Формирование итогового отчета

Необходимо сформировать итоговый отчет в формате .csv. Пример отчета предоставлен в файле `trial_statistics.csv`. Итоговый отчет должен быть сгенерирован через один SQL-запрос и сохранен в формате .csv.

Итоговый запрос необходимо положить в файл `report.sql`.

> Так я все результаты сохранил в src и запушил файлы на GitLab в ветку `develop`. Главврач ничего не сообщил, но кажется нужно ему отписаться, что все Готово и можно проверять.
>> Стажер 

💡 [Нажми сюда](http://opros.so/jSVV1), **чтобы поделиться с нами обратной связью на этот проект**. Это анонимно и поможет команде Продукта сделать твоё обучение лучше.
