# Бэкенд мониторинга пациентов реанимации

Аннотация: в этом проекте ты в составе команды напишешь несколько микросервисов, которые будут эмулировать реанимационный монитор.

## Содержание

1. [Chapter I](#chapter-i) \
   1.1. [Рекомендации к проекту](#рекомендации-к-проекту)
2. [Chapter III](#chapter-ii) \
   2.1. [Задание 1](#задание-1-сервис-пациент) \
   2.2. [Задание 2](#задание-2-работа-с-данными) \
   2.3. [Задание 3](#задание-3-отправка-данных-в-kafka) \
   2.4. [Задание 4](#задание-4-обработчик-исключений) \
   2.5. [Задание 5](#задание-5-проверка-функционала-приложения) \
   2.6. [Задание 6](#задание-6-сервис-обработки-данных) \
   2.7. [Задание 7](#задание-7-работа-с-бд) \
   2.8. [Задание 8](#задание-8-работа-с-kafka) \
   2.9. [Задание 9](#задание-9-проверка-функционала-второго-приложения) \
   2.10. [Задание 10](#задание-10-сервис-мониторинга) \
   2.11. [Задание 11](#задание-11-работа-с-api) \
   2.12. [Задание 12](#бонусное-задание-12-написать-все-3-микросервиса-на-fastapi) \
   2.13. [Задание 13](#бонусное-задание-13-логирование) \
   2.14. [Задание 14](#бонусное-задание-14-тесты) \
   2.15. [Задание 15](#бонусное-задание-15-многопользовательский-режим-для-эмулятора-пациента)

## Введение

Утро началось не с кофе, а с улыбающегося круглого лица Главврача, который навис над твоим столом. 

>— Скучал по мне? Я наконец-то вернулся!
>>**Главврач**

>— Не то чтобы...
>>**Стажер**

>— Вижу искреннюю радость на твоем лице и спешу заверить: ты прекрасно справился с вверенным тебе проектом. 
>>**Главврач**

Ты попытался вспомнить, когда это тебе «вверяли» проект — больше походило на то, что тебе его спихнули. Ты вспомнил, что вчера обнаружил в кабинете Главврача, и решил спросить напрямую.

>— Вениамин и Кларисса — ваши родственники? 
>>**Стажер**

>— Ты все верно догадался, мой дорогой стажер! Кларисса — внучатая племянница моей троюродной бабушки, мы были очень близки в детстве и с тех пор дружим семьями. Когда они обратились ко мне за помощью, я посчитал, что ты достаточно вырос, чтобы справиться с этим проектом самостоятельно, и не ошибся!
>>**Главврач**

Ты вспомнил, как он свинтил в командировку, которой, вероятно, и не было, и бросил тебя на проект, в котором ты ни черта не понимал. Что он там посчитал? На пальцах? Однако спорить с Главврачом, не хотелось, потому что...

>— Вениамин и Кларисса передали мне маленький список доработок, которые они хотели бы увидеть. 
>>**Главврач**

Главврач вдруг вытащил плотную пачку бумаги, чем поверг тебя в ужас. Да ты с этим будешь до следующего года разбираться! И это «маленький список доработок»?! Видимо, разглядев на твоем лице ужас, Главврач хмыкнул. 

>— Мне кажется, что здесь тебе пригодится помощь коллег. Кто готов помочь нашему стажеру?
>>**Главврач**

Главврач обернулся на Лабораторию, и тебе показалось, что по ней пролетело перекати-поле, настолько стало тихо и безжизненно. 

>— Сколько энтузиазма! Сколько горящих глаз! Ладно, раз мы играем в прятки, то я считаю до трех и иду искать. Раз-два-три... А ты пока подожди меня здесь, я добуду тебе команду. 
>>**Главврач**

И он ушел, плотоядно ухмыляясь, а ты остался с толстой пачкой правок смотреть ему вслед. 

## Chapter I

### Рекомендации к проекту

Как учиться в «Школе 21»:

- На протяжении всего курса ты будешь самостоятельно добывать информацию. Пользуйся всеми доступными средствами поиска информации, к примеру, Google и GigaChat. Будь внимателен к источникам информации: проверяй, думай, анализируй, сравнивай.
- Взаимообучение (P2P, Peer-to-Peer) — это процесс, при котором учащиеся обмениваются знаниями и опытом, выступая одновременно в роли учителей и учеников. Этот подход позволяет учиться не только у преподавателя, но и друг у друга, что способствует более глубокому пониманию материала.
- Не стесняйся просить помощи: вокруг тебя такие же пиры, которые тоже проходят этот путь впервые. Не бойся откликаться на просьбы о помощи. Твой опыт ценен и полезен, смело делись им с другими участниками.
- Не списывай, а если пользуешься помощью — всегда разбирайся до конца, почему, как и зачем. Иначе твое обучение не будет иметь никакого смысла.
- Если ты на чем-то застрял и кажется, что все уже перепробовал, но по-прежнему непонятно, куда идти, — просто передохни! Поверь, этот совет помогал многим разработчикам в их работе. Проветрись, перезагрузи голову, и, возможно, в следующий раз тебе наконец придет нужное решение!
- Важен не только результат обучения, но и сам процесс. Нужно не просто решить задачу, а понять, КАК ее решить.

Как работать с проектом:
- Вся работа выполняется на виртуальной машине. Для начала ее нужно настроить, воспользовавшись [инструкцией](https://applicant.21-school.ru/guide_vm_med). Далее запустить виртуальную машину и продолжать выполнять работу над проектом там.
- Перед выполнением проект необходимо склонировать с GitLab в одноименный репозиторий.
- Все файлы с кодом необходимо создавать в папке src склонированного репозитория.
- После клонирования проекта необходимо создать ветку `develop` и вести разработку в ней. После этого пушить в GitLab также нужно ветку `develop`.
- В твоей директории не должно быть иных файлов, кроме тех, что обозначены в заданиях.

Дисклеймер:

- Наша команда не медики. Если ты будешь видеть в тексте медицинские неточности или ошибки, заранее просим у тебя прощения. Оставляй нам обратную связь, и мы все поправим!
- Иногда повествование ведется в несколько шутливой форме, чтобы не было скучно. Однако, как ты и сам знаешь, юмор и шутки — субъективная вещь. Поэтому если каламбуры в данном тексте, по твоему мнению, попахивают батиным юмором, то, пожалуйста, просто прими это.

## Chapter II

Этот проект групповой, так что ты будешь выполнять его в команде. 

В этом проекте ты познакомишься с несколькими новыми фреймворками и напишешь несколько микросервисов, которые будут эмулировать работу монитора в реанимационной палате. Тебе предстоит написать несколько сервисов:

- сервис для работы с данными — data_service, который будет вычитывать данные из Kafka и записывать их в БД;
- сервис для выгрузки данных — monitor_service, который забирает данные из БД и отдает на фронтенд;
- сервис, который эмулирует пациента — patient_service — и отправляет данные каждые 5 секунд в кафку.

В следующем групповом проекте ты будешь писать фронтенд для monitor_service, который будет отображать графики и все метрики пациента, будь готов к этому. :)

### Задание 1. Сервис-пациент

В этом проекте тебе предстоит попробовать новый фреймворк — FastApi. Обязательно почитай про различия Django и FastApi и заодно о Flask в свободное время.

1. Начни с того, что создай проект, добавь следующие зависимости в `requirements.txt` и установи их в виртуальное окружение.

    ```markdown
    fastapi==0.104.1
    uvicorn==0.24.0
    pydantic==2.4.2
    aiokafka==0.8.2
    prometheus-client==0.19.0
    prometheus-fastapi-instrumentator==6.1.0
    python-dotenv==1.0.0
    structlog==23.2.0
    pytest==7.4.3
    pytest-asyncio==0.21.1
    pytest-cov==4.1.0 
    ```

2. Создай файл `config.py`, в котором опиши настройки, унаследованные от `BaseSettings` из `pydantic` со следующими параметрами:
    - `KAFKA_BOOTSTRAP_SERVERS` — адреса Kafka-серверов;
    - `KAFKA_TOPIC` — имя темы Kafka для отправки метрик;
    - `API_PREFIX` — префикс для API эндпоинтов;
    - `DEBUG` — режим отладки;
    - `METRICS_INTERVAL` — интервал генерации метрик в секундах;
    - `PATIENT_UUID` — идентификатор пациента (будет задаваться при запуске).

    _Топики кафки можно найти и создать через консоль._

3. В `main.py` опиши запуск приложения (посмотри примеры). Ключевые слова `fastapi` и `uvicorn` помогут тебе найти решение. :)

### Задание 2. Работа с данными

Начни описывать отправку данных пациента:

1. Создай `metrics.py`.
2. Опиши класс `MetricsService`, а в нем метод `generate_metrics`, сгенерируй следующие параметры:

    - `timestamp` — время снятия метрики;
    - `pulse` — ЧСС;
    - `resp_rate` — ЧДД;
    - `bp` — давление в виде 120/80;
    - `spo2` — сатурация;
    - `temperature` — температура.

Можно просто задать генерацию рандомом, например, для пульса rand(60, 100). Для следующего задания пригодится иметь хорошие и плохие значения в генерации (например, очень высокий пульс, температура и т. д.).

### Задание 3. Отправка данных в Kafka

Еще кое-что новое! `Kafka` — это система обмена сообщениями между сервисами. Используют ее для повышения отказоустойчивости, улучшения производительности, да и вообще, у этой технологии есть очень много применений. В этом проекте Kafka будет выступать брокером сообщений между сервисом пациента и сервисом `data_service`, который пишет в БД.

Кафка позволяет сервису-пациенту непрерывно отправлять жизненные показатели, а сервису обработки данных — получать их независимо от скорости обработки. Это обеспечивает бесперебойную работу системы даже при увеличении нагрузки или временных сбоях одного из сервисов. Фактически Kafka действует как буфер между генератором данных и их потребителем, гарантируя, что ни одно измерение не будет потеряно.

*В интернете полно статей по кафке, прочитай хотя бы [эту](https://habr.com/ru/companies/kuper/articles/738634/) и [эту](https://selectel.ru/blog/apache-kafka/)*.

1. Создай файл `kafka.py`.
2. Сделай в нем `KafkaService` и предусмотри функции `start`, `stop`, `send_metrics`.
3. Настройки подтягивай из `config.py`.
4. Теперь в `MetricsService` опиши `send_metrics`, который будет работать с `KafkaService`, и `start_monitoring`, который будет запускать `send_metrics` по расписанию.
5. Наконец, в `main.py` опиши функцию с аннотацией `@app.on_event("startup")`, которая будет запускать процесс генерации и отправки данных.

### Задание 4. Обработчик исключений

Для работы приложения ты уже использовал try-catch. Теперь сделай собственный обработчик:

1. Создай `exceptions.py`.
2. В нем создай базовый класс для исключений сервиса `PatientServiceException`, унаследуйся от `HTTPException`.
3. Создай несколько исключений, например, `PatientNotFoundError`, `KafkaError`.
4. Создай метод `exception_handler`, в котором опиши логику обработки ошибок.

### Задание 5. Проверка функционала приложения

Задачи у тебя стояли непростые, и пора проверить, что все работает. Приложение должно:
- запускаться,
- находить топик кафки,
- генерировать данные в формате, описанном в Задании 2,
- отправлять в кафку эти данные.

Если у тебя не получается сделать эти задания на FastApi, не переживай. Возьми Django, в котором ты уже провел достаточно много времени, и опиши этот функционал там. Есть ты выполнишь все задания на FastApi, то в конце проекта получишь выполненное бонусное задание.

### Задание 6. Сервис обработки данных

Переходи к разработке сервиса, который будет потребителем сообщений из кафки — `data_service`.

Зависимости, которые можно использовать (если потребуется что-то еще, можешь добавить):

```markdown
- fastapi
- uvicorn
- sqlalchemy
- pydantic
- python-dotenv
- aiokafka
- prometheus-client
- pytest
- pytest-asyncio
- httpx
- loguru
- databases[sqlite]
- orjson
- python-multipart
```

1. Создай приложение, опиши в `main.py` базовый запуск.
2. Сделай файл с конфигом, подтяни настройки в `main.py`.

### Задание 7. Работа с БД

SQLite — еще одна БД, с которой пора познакомиться. :) Будем хранить ее локально, с ней же будет работать и следующий сервис — сервис отправки данных на фронтенд.

1. Опиши файл `database.py`, который будет реализовывать возможность настройки соединения с БД.
2. Опиши модели `Patient` и `PatientMetric` и свяжи их. У одного `пациента` может быть много `метрик`.
    - `Patient` — модель для хранения информации о пациенте (имя, uuid и т. д.);
    - `PatientMetric` — модель для хранения метрик пациентов (пульс, давление и т. д.).
3. В `main.py` при запуске приложения должна проходить инициализация БД.

### Задание 8. Работа с Kafka

1. В `kafka.py` сделай `KafkaService`, сделай функции `start`, `stop` и `process_messages`, которая будет заниматься обработкой сообщения.
2. Для раскладки в БД сделай `data.py`, в нем `DataService`, а уже в нем создай функцию сохранения данных в БД, которые будут брать данные из сообщения.

### Задание 9. Проверка функционала второго приложения

На этом этапе проверь свое приложение. Оно должно:
- запускаться,
- находить топик кафки,
- принимать данные в формате, описанном в Задании 2,
- сохранять в БД пользователя и его метрики.

*В Kafka «топик» — это именованный канал для передачи сообщений. Сервисы могут публиковать или читать сообщения из определенных топиков.*

Как и в прошлом задании, если у тебя не получается сделать эти задания на FastApi, не переживай. Возьми Django, в котором ты уже провел достаточно много времени, и опиши этот функционал там. Есть ты выполнишь все задания на FastApi, то в конце проекта получишь выполненное бонусное задание.

### Задание 10. Сервис мониторинга

Ура, ты на финишной прямой! Остался последний сервис, который будет отвечать за передачу данных на фронтенд, — `monitor_service`.

Зависимости, которые можно использовать (если потребуется что-то еще, можешь добавить):

```markdown
fastapi==0.104.1
uvicorn==0.24.0
pydantic==2.4.2
sqlalchemy==2.0.23
aiosqlite==0.19.0
aiokafka==0.8.2
prometheus-client==0.19.0
prometheus-fastapi-instrumentator==6.1.0
python-dotenv==1.0.0
structlog==23.2.0
pytest==7.4.3
pytest-asyncio==0.21.1
pytest-cov==4.1.0
```

1. Снова сделай `main.py` и опиши запуск приложения.
2. Сделай `config.py` с настройками.

### Задание 11. Работа с API

1. Опиши модели в `models.py`: тебе понадобится читать данные из БД и отправлять их по эндпоинтам.
2. Опиши работу с БД в `database.py`.
3. Сделай `routes.py` и опиши там следующие API:
    - `GET /patients` — получение списка пациентов;
    - `GET /patient/{patient_uuid}/metrics` — получение метрик пациента.

_В этом задании та же логика. :) Если получилось на FastApi написать все 3 сервиса, то следующее бонусное задание уже твое._

### Бонусное задание 12. Написать все 3 микросервиса на FastApi

Все видно из названия. :) Если ты справился и все написано на FastApi, то это задание выполнено! Если нет — не переживай, разработка — это сфера, где никогда не перестаешь изучать новое, у тебя получится разобраться в этом фреймворке, главное — делать.

### Бонусное задание 13. Логирование

Логирование поможет при отладке и наградит бонусными очками! Если еще не внедрял для себя, самое время внедрить:

1. Сделай `logging.py`, настрой логирование. Ниже показываем кастомный логгер:

    ```python
        log_data: Dict[str, Any] = {
    "timestamp": self.formatTime(record),
    "level": record.levelname,
    "message": record.getMessage(),
    "module": record.module,
    "function": record.funcName,
    "line": record.lineno
    }
    ```

2. Добавь логгер в каждый сервис, сделай логирование основных действий (хотя бы 1 на класс).

### Бонусное задание 14. Тесты

Куда же без тестов! :)

1. Добавь 1 юнит-тест и 1 функциональный тест в каждое приложение, опиши их в файле `tests.py`.

### Бонусное задание 15. Многопользовательский режим для эмулятора пациента

Чтобы посмотреть, как приложение справляется с большой нагруженностью, сделай возможность запускать несколько сервисов.

1. Добавь аргументы, чтобы можно было запускать на разных портах.
2. Добавь name пациента, чтобы запуск выглядел вот так: `...main.app -name1 -8080`.

Теперь у тебя есть 3 микросервиса, которые живут отдельно друг от друга, но при этом постоянно взаимодействуют. В следующем проекте ты сделаешь фронтенд, чтобы за состоянием больного можно было наблюдать на экране!

---

Оказалось, что появление Главврача — не всегда плохая примета. Его молниеносная атака на Лабораторию принесла тебе немало пользы, потому что делать проект не одному было намного проще и веселее. Правда, ты не мог сказать, что твои коллеги чувствуют то же самое — на их лицах была написана чистая обреченность. 

>— Молодцы, все молодцы! Финишная прямая! Завтра придут Вениамин с Клариссой, чтобы принимать приложение. Будь готов.
>>**Главврач**

Ты был совсем не готов. Но кого это волновало? 

💡 [Нажми сюда](https://oprosso.ru/p/ad3bc98eb2a54c0baf4679fa722b54df), **чтобы поделиться с нами обратной связью на этот проект**. Это анонимно и поможет команде Продукта сделать твое обучение лучше.