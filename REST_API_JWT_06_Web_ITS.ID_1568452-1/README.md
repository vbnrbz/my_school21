# REST API

Аннотация: \
Данный проект научит тебя работать с REST API.

## Содержание

1. [Chapter I](#chapter-i) \
   1.1. [Рекомендации к проекту](#рекомендации-к-проекту)
2. [Chapter II](#chapter-ii) \
   2.1. [Описание проекта](#описание-проекта) \
   2.2. [Теория REST API](#теория-rest-api)
3. [Chapter III](#chapter-iii) \
   2.1. [Задание 1](#задание-1-базовое-приложение) \
   2.2. [Задание 2](#задание-2-создание-rest-api) \
   2.3. [Задание 3](#задание-3-пользователи) \
   2.4. [Задание 4](#задание-4-эндпоинты-для-врачей) \
   2.5. [Задание 5](#задание-5-эндпоинты-для-пациентов) \
   2.6. [Задание 6](#задание-6-эндпоинт-для-получения-uuid-врача-по-информации-о-нем) \
   2.7. [Задание 7](#задание-7-эндпоинт-для-получения-uuid-пациента-по-информации-о-нем) \
   2.8. [Задание 8](#задание-8-эндпоинт-для-создания-встреч) \
   2.9. [Задание 9](#бонусное-задание-9-отмена-встречи) \
   2.10. [Задание 10](#бонусное-задание-10-сваггер)

## Введение 

Проект для клиники «Здоровый дух» был в самом разгаре, хотя ты и надеялся, что он поскорее закончится, и тебя освободят. Правда, ты уже постепенно начал входить во вкус, и веб-разработка тебе даже нравилась. Другое дело, ты осознал, что большую часть времени веб-разработчик не кодит, а... пытается понять, что от него хотят клиенты. 

Вот и сегодня, хотя у тебя были совершенно другие планы (например, узнать у коллег, где Главврач), тебе позвонил Вениамин. 

>— Доброе утро! Авторизация — просто бомба, именно то, что мы и хотели. Мы ужасно рады, что нам порекомендовали вас. 
>>**Вениамин**

>— Порекомендовали??
>>**Стажер**

>— В общем, теперь бы хотелось немного это расширить, добавить возможность назначать приемы с пациентами, проверять, свободен ли врач, и все прочее. Ну вы понимаете. Есть даже какая-то штука в помощь, вроде называется вест или рест...
>>**Вениамин**

>— REST. 
>>**Стажер**

>— Точно, оно. Короче, как обычно надеемся на вас! 
>>**Вениамин**

>— У меня к вам был один вопрос по поводу нашего Главврача...
>>**Стажер**

>— Бип-бип-бип...
>>**Телефон Вениамина**

Клиент отключился, даже не потрудившись ответить. Ты почувствовал раздражение. Во-первых, это было грубо. Во-вторых, что за тайна такая? Ты твердо решил все проверить после того, как разберешься с заданием...

## Chapter I

### Рекомендации к проекту

Как учиться в «Школе 21»:

- На протяжении всего курса ты будешь самостоятельно добывать информацию. Пользуйся всеми доступными средствами поиска информации, к примеру, Google и GigaChat. Будь внимателен к источникам информации: проверяй, думай, анализируй, сравнивай.
- Взаимообучение (P2P, Peer-to-Peer) — это процесс, при котором учащиеся обмениваются знаниями и опытом, выступая одновременно в роли учителей и учеников. Этот подход позволяет учиться не только у преподавателя, но и друг у друга, что способствует более глубокому пониманию материала.
- Не стесняйся просить помощи: вокруг тебя такие же пиры, которые тоже проходят этот путь впервые. Не бойся откликаться на просьбы о помощи. Твой опыт ценен и полезен, смело делись им с другими участниками.
- Не списывай, а если пользуешься помощью — всегда разбирайся до конца, почему, как и зачем. Иначе твое обучение не будет иметь никакого смысла.
- Если ты на чем-то застрял и кажется, что все уже перепробовал, но по-прежнему непонятно, куда идти, — просто передохни! Поверь, этот совет помогал многим разработчикам в их работе. Проветрись, перезагрузи голову, и, возможно, в следующий раз тебе наконец придет нужное решение!
- Важен не только результат обучения, но и сам процесс. Нужно не просто решить задачу, а понять, КАК ее решить.

Как работать с проектом:
- Вся работа выполняется на виртуальной машине. Для начала ее нужно настроить, воспользовавшись [инструкцией](https://applicant.21-school.ru/guide_vm_med). Далее запустить виртуальную машину и продолжать выполнять работу над проектом там.
- Перед выполнением проект необходимо склонировать с GitLab в одноименный репозиторий.
- Все файлы с кодом необходимо создавать в папке src склонированного репозитория.
- После клонирования проекта необходимо создать ветку `develop` и вести разработку в ней. После этого пушить в GitLab также нужно ветку `develop`.
- В твоей директории не должно быть иных файлов, кроме тех, что обозначены в заданиях.

Дисклеймер:

- Наша команда не медики. Если ты будешь видеть в тексте медицинские неточности или ошибки, заранее просим у тебя прощения. Оставляй нам обратную связь, и мы все поправим!
- Иногда повествование ведется в несколько шутливой форме, чтобы не было скучно. Однако, как ты и сам знаешь, юмор и шутки — субъективная вещь. Поэтому если каламбуры в данном тексте, по твоему мнению, попахивают батиным юмором, то, пожалуйста, просто прими это.

## Chapter II

### Описание проекта

Ты уже немного начал изучать REST API, а в этом проекте ты расширенно посмотришь на REST API. В этот раз в рамках монолита.

### Теория REST API

REST (Representational State Transfer) — это архитектурный стиль для создания веб-сервисов. Основные принципы REST:

1. **Клиент-серверная архитектура**: четкое разделение между клиентом и сервером.
2. **Без сохранения состояния (Stateless)**: каждый запрос содержит всю необходимую информацию.
3. **Единообразие интерфейса**: стандартизированный способ взаимодействия.
4. **Слоистая система**: клиент не знает, с каким слоем сервера взаимодействует.

#### Пример работы REST API

Рассмотрим пример работы с API для управления пациентами:

1. **Получение списка пациентов**:

    ```http
    GET /api/patients/all
    Response:
    [
       {
            "patient_id": "550e8400-e29b-41d4-a716-446655440000",
            "fio": "Иванов Иван Иванович",
            "birth_date": "1990-01-01",
            "patient_age": 34,
            "notes": "Аллергия на пенициллин"
        }
    ]
    ```

2. **Создание нового пациента**:

    ```http
    POST /api/patients/create
    Request Body:
    {
        "fio": "Петров Петр Петрович",
        "birth_date": "1985-05-15",
        "notes": "Хронический бронхит"
    }
    Response:
    {
        "patient_id": "550e8400-e29b-41d4-a716-446655440001",
        "fio": "Петров Петр Петрович",
        "birth_date": "1985-05-15",
        "patient_age": 39,
        "notes": "Хронический бронхит"
    }
    ```

#### Пример Swagger-документации

Swagger (OpenAPI) — это инструмент для описания и документирования REST API. Вот пример документации для эндпоинта создания пациента:

```yaml
paths:
  /api/patients/create:
    post:
      summary: Создание нового пациента
      description: Создает нового пациента в системе
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - fio
                - birth_date
              properties:
                fio:
                  type: string
                  description: ФИО пациента
                birth_date:
                  type: string
                  format: date
                  description: Дата рождения
                notes:
                  type: string
                  description: Дополнительные заметки
      responses:
        '201':
          description: Пациент успешно создан
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Patient'
        '400':
          description: Неверные входные данные
```

## Chapter III

❗ Ты можешь скопировать файлы из предыдущего проекта и продолжать работу над ними или создать новое приложение и выполнять задания из этого проекта.

### Задание 1. Базовое приложение

Чтобы продолжать работу над приложением, тебе понадобятся:

1. django-проект и приложение;
2. описанные модели в БД:
    - врача (**Doctor**) — пусть у него будут поля doctor_id (тип uuid), fio (text), available (boolean), specialty(text);
    - пациента (**Patient**) — у него будут поля patient_id (тип uuid), fio (text), birth_date (date), patient_age (integer), notes (text), prescriptions (json);
    - кабинет (**Room**) — room_id (int), room_name (text), available (boolean);
    - запись (**Appointment**) — appointment_id (uuid), doctor_id (uuid), patient_id (uuid), room_number(int), date (DateTime), notes (text), prescriptions (json), cancelled (boolean);
3. созданные связи — запись привязана к доктору, пациенту и кабинету.

### Задание 2. Создание REST API

В прошлом проекте ты уже частично посмотрел на REST API. Сегодня же ты создашь RESTful-сервис. Для этого нужно обеспечить каждую сущность следующими возможностями:

1. создать сущность: POST `api/<entity>/create`;
2. удалить сущность: DELETE `api/<entity>/<id>`;
3. получить все сущности: GET `api/<entity>`;
4. получить одну сущность: GET `api/<entity>/<id>`;
5. обновить выбранные поля одной сущности: PATCH `api/<entity>/<id>`;
6. обновить одну сущность полностью: POST/PUT `api/<entity>/<id>`.

Апишки, иногда их еще называют «ручки», — очень удобное взаимодействие с сервисом. Они выполняют в некотором смысле принципы ООП — инкапсуляцию и абстракцию. Так, тебе неважно, как именно будут обработаны данные, но важно, что есть контракт, который гарантирует формат и состав данных, которые поступают и выходят в/из сервиса по эндпоинту.

#### Объектно-ориентированное программирование (ООП)

В данном проекте упоминаются принципы ООП. Основные концепции ООП, которые нужно знать:

1. **Инкапсуляция**: сокрытие внутренней реализации объектов.
2. **Наследование**: переиспользование кода через наследование классов.
3. **Полиморфизм**: возможность использовать разные типы объектов через единый интерфейс.
4. **Абстракция**: создание абстрактных моделей данных, которые представляют реальные сущности.

Эти принципы помогают создавать более поддерживаемый и расширяемый код, что особенно важно при разработке REST API.

Выполни следующее: сейчас сделай подобное API для сущности `Room`. Обеспечь работу всех 6 эндпойнтов.

### Задание 3. Пользователи

В этом проекте тебе предстоит сделать авторизацию пользователя средствами Django. Тебе уже частично пришлось поработать с этой темой, но в предыдущем проекте ты формировал токен JWT и отправлял его в основное приложение. Сейчас же для изучения REST, ролей и ограничения доступа воспользуемся монолитным решением, когда приложение знает о своих пользователях все.

1. В моделях своего приложения добавь кастомного пользователя и предусмотри связь OneToOne с доктором или пациентом.
2. Опиши сериализаторы, которые будут обрабатывать данные регистрации (я бы назвал классы `DoctorRegisterSerializer` и `PatientRegisterSerializer`). Добавь `username` и `password` для определения `Meta`. 
3. Используя `rest_framework`, опиши `views.py` (посмотри на `generics.CreateAPIView`).
4. Не забудь добавить в настройки `AUTH_USER_MODEL`.
5. При регистрации `doctor` обязательны поля `fio` и `speciality`.
6. При регистрации `patient` обязательны поля `fio`, `birth_date`. Age вычисляется автоматически на момент записи в БД (упрощение для учебного проекта, в реальной ситуации Age вычислялся бы при обращении к нему).

### Задание 4. Эндпоинты для врачей

Обеспечь сущность врача следующими эндпоинтами:

1. обновление врача (PUT `api/doctors/<uuid>`);
2. получение данных о враче (GET `api/doctors/<uuid>`);
3. получение данных обо всех встречах врача (GET `api/doctors/<uuid>/appointments`) — пусть уже будет эндпоинт, но пока он возвращает пустой список;
4. получение списка всех врачей (GET `/api/doctors/all`).

### Задание 5. Эндпоинты для пациентов

Обеспечь сущность пациента следующими эндпоинтами:

1. обновление информации о пациенте (PATCH `api/patients/<uuid>`);
2. получение данных о пациенте (GET `api/patients/<uuid>`);
3. получение списка всех пациентов (GET `/api/patients/all`);
4. добавление данных о назначениях (POST `api/patients/<uuid>/prescriptions`) в формате json — простой массив, например.

    ```json
    [
      {
        "drug": "B1",
        "dosage": "2mg",
        "repeat": "twice a day"
      },
      {
        "drug": "B3",
        "dosage": "1mg",
        "repeat": "once a day"
      }
    ]
    ```

### Задание 6. Эндпоинт для получения UUID врача по информации о нем

Хорошо, когда есть доступ к админке и можно найти там UUID врача. Но это очень редкий случай, чаще всего тебе придется каким-то образом, конечно, идентифицировать строку в таблице БД через апишку. Например, в этом задании тебе предстоит сделать получение UUID по `ФИО` и `Специальности` врача. Этот эндпоинт будет очень полезен для создания встреч, ведь они формируются при помощи UUID участников.

1. Сформируй эндпоинт `api/doctors/lookup/`, в котором обеспечь поиск врача (выдавай в ответ `UUID`) по `ФИО` + `Специальность`.

### Задание 7. Эндпоинт для получения UUID пациента по информации о нем

Сделай такой же функционал для пациента.

1. Сформируй эндпоинт `api/patients/lookup/`, в котором обеспечь поиск пациента (выдавай в ответ `UUID`) по `ФИО` + `ДР`.

### Задание 8. Эндпоинт для создания встреч

В этом эндпоинте есть загвоздка: нужно создавать `Appointment` для существующих врачей и пациентов. Сейчас опиши только API для работы со встречами. Для этого:

1. Принимай на вход `doctor_id`, `patient_id`, `room_id`, `date`.
2. `appointment_id` должен создаваться автоматически.
3. При создании проверяй:
    - врач должен существовать;
    - врач должен быть доступен;
    - пациент должен существовать;
    - дата должна быть в будущем (сделай, чтобы можно было ставить встречи только на следующий день с 9 утра).
4. Если какие-то данные не совпадают, выдавай человекочитаемую ошибку.

### Бонусное задание 9. Отмена встречи

Сделай эндпоинт, который будет отменять встречу. Метод должен просто отправлять сообщение об отмене приема, не изменяя другие данные:

1. Подбери правильный метод обращения к `REST`.
2. На вход принимай `appointment_id`.
3. Если такой `appointment_id` не существует — выдавай ошибку.
4. При получении запроса меняй данные в столбце `cancelled` на `true`.

### Бонусное задание 10. Сваггер

`Swagger` (и `Redoc`) — инструменты описания API. В этом задании тебе предстоит описать эндпоинты, указать примеры входных и выходных данных. Например, для кабинетов `Swagger` выглядел бы вот так:

![swagger](misc/images/swagger.png)

1. Установи фреймворк `drf-spectacular`.
2. Используй `@extend_schema` для описания информации об эндпоинтах.

Это был очень важный проект, ведь работа с REST — ежедневная задача почти всех веб-разработчиков. Принять данные, обработать их и отдать результат — основа взаимодействия сервисов. Если ты справился с описанием сваггера — фронтендер и тестировщик выдадут тебе отдельную благодарность. :)

---

Все получилось в лучшем виде, и ты чувствовал, что чем больше работаешь над этим проектом, тем круче становишься. Несмотря на бесконечные и зачастую непонятные правки и запросы от Вениамина и Клариссы, тебе пока удавалось все реализовывать. Оказывается, на учебе не лгали: в реальной жизни с клиентами постоянно приходится сложно.

Почему-то вспомнив о Главвраче, ты открыл приложение и решил кое-что попробовать. Ввел его ФИО и нашел учетную запись. И у тебя возникла забавная мысль, как можно выманить его на свет... Однако пока ты решил отложить этот момент. Вместо этого ты демонстративно начал собирать вещи, чтобы уйти домой. Как и ожидалось: стоило тебе подняться с места, как на телефон пришла СМС:

>Отличная работа! 
>>**СМС от Главврача**

Кажется, ты постепенно начал догадываться, к чему вся эта скрытность. 

💡 [Нажми сюда](https://oprosso.ru/p/ad3bc98eb2a54c0baf4679fa722b54df), **чтобы поделиться с нами обратной связью на этот проект**. Это анонимно и поможет команде Продукта сделать твое обучение лучше.