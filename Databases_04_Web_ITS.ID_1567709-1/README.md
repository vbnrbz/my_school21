# Работа с БД и моделями

Аннотация: \
Данный проект научит тебя работать с БД более подробно.

## Содержание
1. [Chapter I](#chapter-i) \
   1.1. [Рекомендации к проекту](#рекомендации-к-проекту)
2. [Chapter II](#chapter-ii) \
   2.1. [Задание 1](#задание-1-настройка-базы-и-окружений) \
   2.2. [Задание 2](#задание-2-создание-моделей-и-миграций) \
   2.3. [Задание 3](#задание-3-перенесение-crud-на-базу) \
   2.3. [Задание 4](#задание-4-продвинутые-запросы-к-бд) \
   2.3. [Задание 5](#задание-5-отладка-документация-и-итоговое-оформление) \
   2.3. [Задание 6](#задание-6-экспорт-в-файл) \
   2.3. [Задание 7](задание-7-сложные-валидаторы-и-ограничения) \
   2.4. [Бонусное задание 8](#бонусное-задание-8-импорт-из-файла) 

## Введение

Ты подозревал, что сегодня не совсем обычный день. Все потому, что Вениамин и Кларисса пришли с двумя огромными коробками, которые сгрузили на стол в конференц-зале. Тебя охватило дурное предчувствие. 

>— Что это такое?..
>>**Стажер**

>— Это наша база данных.
>>**Кларисса**

Ты почему-то так и думал. Вениамин гордо извлек из коробки папку и открыл ее. В воздух взметнулась застарелая пыль, которая наверняка была старше тебя. Кто и когда последний раз разбирал эту «базу данных»?

>— Вот это список наших врачей. 
>>**Вениамин**

>— Потрясающе...
>>**Стажер**

Ты смотрел на почерк, который можно было описать только как «великолепная мазня», и гадал: это Иванов или Киранов? 

>— Здесь, конечно, не вся наша долгая история, ведь клиника «Здоровый дух» уже много лет предоставляет пациентам самое качественное обслуживание. Однако мы понимаем, что пришло время двигаться в ногу со временем, поэтому и решили создать приложение. 
>>**Кларисса**

>— А сколько всего у вас таких коробок? 
>>**Стажер**

>— Там на улице еще фура стоит.
>>**Вениамин**

Тебя прошиб холодный пот. Если ты будешь создавать базу данных по этим документам, то закончишь примерно в возрасте Главврача. И не факт, что не ослепнешь, пытаясь разобрать эти каракули. Ты огляделся по сторонам, ища, как бы аккуратно выйти из конференц-зала и больше никогда не приходить в Лабораторию. К счастью, в этот момент Кларисса положила на стол флешку. 

>— Мы уже оцифровали данные, они вот здесь. Надеюсь, вы сможете присоединить базу данных к веб-приложению. А мы пока пойдем — у нашего сына сегодня в школе конкурс, кто больше соберет макулатуры. 
>>**Кларисса**

Кажется, ты слишком стар уже для таких эмоциональных качелей — и этих клиентов как минимум. 

## Chapter I
### Рекомендации к проекту

Как учиться в «Школе 21»:
- На протяжении всего курса ты будешь самостоятельно добывать информацию. Пользуйся всеми доступными средствами поиска информации, к примеру, Google и GigaChat. Будь внимателен к источникам информации: проверяй, думай, анализируй, сравнивай.
- Взаимообучение (P2P, Peer-to-Peer) — это процесс, при котором учащиеся обмениваются знаниями и опытом, выступая одновременно в роли учителей и учеников. Этот подход позволяет учиться не только у преподавателя, но и друг у друга, что способствует более глубокому пониманию материала.
- Не стесняйся просить помощи: вокруг тебя такие же пиры, которые тоже проходят этот путь впервые. Не бойся откликаться на просьбы о помощи. Твой опыт ценен и полезен, смело делись им с другими участниками.
- Не списывай, а если пользуешься помощью — всегда разбирайся до конца, почему, как и зачем. Иначе твое обучение не будет иметь никакого смысла.
- Если ты на чем-то застрял и кажется, что все уже перепробовал, но по-прежнему непонятно, куда идти, — просто передохни! Поверь, этот совет помогал многим разработчикам в их работе. Проветрись, перезагрузи голову, и, возможно, в следующий раз тебе наконец придет нужное решение!
- Важен не только результат обучения, но и сам процесс. Нужно не просто решить задачу, а понять, КАК ее решить.

Как работать с проектом:
- Вся работа выполняется на виртуальной машине. Для начала ее нужно настроить, воспользовавшись [инструкцией](https://applicant.21-school.ru/guide_vm_med). Далее запустить виртуальную машину и продолжать выполнять работу над проектом там.
- Перед выполнением проект необходимо склонировать с GitLab в одноименный репозиторий.
- Все файлы с кодом необходимо создавать в папке src склонированного репозитория.
- После клонирования проекта необходимо создать ветку `develop` и вести разработку в ней. После этого пушить в GitLab также нужно ветку `develop`.
- В твоей директории не должно быть иных файлов, кроме тех, что обозначены в заданиях.

Дисклеймер:
- Наша команда не медики. Если ты будешь видеть в тексте медицинские неточности или ошибки, заранее просим у тебя прощения. Оставляй нам обратную связь, и мы все поправим!
- Иногда повествование ведется в несколько шутливой форме, чтобы не было скучно. Однако, как ты и сам знаешь, юмор и шутки — субъективная вещь. Поэтому если каламбуры в данном тексте, по твоему мнению, попахивают батиным юмором, то, пожалуйста, просто прими это.


## Chapter II
Ты уже научился обрабатывать формы и сохранять данные. Пора перейти к более продвинутым операциям с БД.

❗ Ты можешь скопировать файлы из предыдущего проекта и продолжать работу над ними или создать новое приложение и выполнять задания из этого проекта.

### Задание 1. Базовое приложение

Чтобы продолжать работу над приложением, тебе понадобятся:
1. django-проект и приложение;
2. страница `/doctors` с карточками врачей, информация о которых передается из БД;
3. описанные модели в БД:
   - врача (**Doctor**) — пусть у него будут поля doctor_id (тип uuid), fio (text), available (boolean), specialty(text);
   - пациента (**Patient**) — у него будут поля patient_id (тип uuid), fio (text), birth_date (date), patient_age (integer), notes (text), prescriptions (json);
   - кабинет (**Room**) — room_id (int), room_name (text), available (boolean);
   - запись (**Appointment**) — appointment_id (uuid), doctor_id (uuid), patient_id (uuid), room_number(int), date (DateTime), notes (text), prescriptions (json), cancelled (boolean).
4. Также нужно создать связи: запись привязана к доктору, пациенту и кабинету.

#### Логическая структура базы данных

Пора поговорить о том, как на самом деле организованы данные в базе данных и почему это так важно.

В основе любой реляционной базы данных (а в данном проекте используется именно такая) лежит понятие **Primary Key** (первичный ключ). Это уникальный идентификатор, который однозначно определяет каждую запись в таблице. В этом проекте первичными ключами являются: `doctor_id`, `patient_id`, `room_id` и `appointment_id`.

Представь себе первичный ключ как номер паспорта. У каждого человека он свой, уникальный, и меняется только в исключительных случаях (и то с большой головной болью для всех заинтересованных сторон). В базах данных то же самое: первичный ключ должен быть уникальным и (в идеальном мире) никогда не меняться.

При установлении связей между таблицами используются эти первичные ключи для установления отношений. Например, в записи `Appointment` есть поля `doctor_id` и `patient_id` — это **Foreign Keys** (внешние ключи), которые ссылаются на первичные ключи таблиц `Doctor` и `Patient` соответственно.

Такая структура позволяет эффективно хранить и получать данные, не дублируя их многократно. Вместо того чтобы хранить все данные о враче в каждой записи о приеме, достаточно хранить ссылку на врача через его `doctor_id`.

#### ER-диаграмма и нормализация

В рамках этого задания тебе также нужно:

1. Создать ER-диаграмму (Entity-Relationship, диаграмму связей сущностей) для базы данных приложения. ER-диаграмма — это визуальное представление структуры базы данных, показывающее сущности (таблицы), их атрибуты (поля) и связи между ними. Такая диаграмма помогает лучше понять структуру данных и взаимосвязи между ними.

Для создания ER-диаграммы можно использовать онлайн-инструменты: [draw.io](https://draw.io), [diagrams.net](https://diagrams.net), [lucidchart](https://lucidchart.com).

**Обязательно сохрани ER-диаграмму в формате изображения (PNG или JPG) или PDF и загрузи ее в репозиторий в папку `src/docs/` с именем `er_diagram`.**

2. Проанализировать структуру базы данных и привести ее к третьей нормальной форме (3НФ). Нормализация — это процесс организации данных для минимизации избыточности и зависимостей. Третья нормальная форма требует, чтобы:
   - таблица была во второй нормальной форме (все неключевые атрибуты функционально полно зависят от первичного ключа);
   - все неключевые атрибуты не зависели друг от друга (то есть не было транзитивных зависимостей).

Если при создании ER-диаграммы ты обнаружишь, что структура не соответствует 3НФ, предложи необходимые изменения для ее нормализации. Помни: хорошо спроектированная база данных — залог эффективной работы приложения и отсутствия проблем с данными в будущем!

### Задание 2. Редактирование информации о докторе

Помнишь, у врача есть параметры `fio`, `available`, `specialty`? Все они могут меняться в зависимости от жизненных ситуаций — например, врач вышла замуж и поменяла `фамилию` (и тут же ушла в отпуск, поэтому стала `available: false`), а другой врач недавно решил сменить `специализацию`.
Для всего этого необходимы возможности редактировать данные. 

Начнем с того, что врачу нужен личный кабинет. Но его стоит сделать в следующих проектах, а пока создадим форму редактирования информации:
1. Пусть теперь по адресу `/doctor/edit/` будет доступна форма для изменения данных о враче.
2. При сохранении изменяются данные врача. Обрати внимание, что `doctor_id` остается прежним и не меняется ни в коем случае.

А почему, собственно, нельзя менять `doctor_id`? Тут все просто (на самом деле не очень, но стоит разобраться).

Представь, что ты поменял `doctor_id` у врача Иванова. В результате возникает проблема: все записи на прием (`Appointment`), которые ссылались на старый `doctor_id`, внезапно стали «подвешенными» — они указывают на несуществующего врача! Это то же самое, как если бы ты поменял номер своего паспорта, но забыл сообщить об этом в банк, налоговую, страховую и еще 100500 организаций. Для них ты внезапно перестал существовать!

Именно поэтому в хорошо спроектированных базах данных первичные ключи никогда не меняют — это сохраняет целостность данных и не позволяет системе превратиться в кашу из несвязанных записей.

Здесь ты будешь работать в файлах:
- `doctor_edit.html`, который лежит в директории `templates/`;
- `forms.py`;
- `urls.py`;
- `views.py`.

### Задание 3. Удаление доктора
Добавь возможность удалять данные о враче:
1. По адресу `/doctor/edit/` на форме пусть будет дополнительная кнопка «Удалить».
2. Удаление должно стирать строку с этим доктором из БД.

Здесь ты будешь работать в файлах:
- `doctor_edit.html`, где добавишь кнопку для удаления доктора (и добавишь переадресацию на `/doctors`);
- `urls.py`;
- `views.py`.

### Задание 4. Фильтрация и сортировка
Чтобы прочувствовать преимущества БД, реализуем пару «продвинутых фишек», например, фильтрацию/сортировку по специальности, ФИО, доступности.

1. Сделай фильтрацию по параметрам. Здесь потребуется не только изменить бэк, но и фронт:
  - На страничку, где отображаются все данные о врачах (`/doctors`), добавь поля ввода для фильтров.
  - Сделай фильтрацию по полям: ФИО, специальность и галочка доступности.

2. Сделай сортировку по параметрам. Здесь тоже потребуется не только изменить бэк, но и фронт:
  - На страничку, где отображаются все данные (`/doctors`), добавь кнопку для сортировки по значению (убывание/возрастание).
  - Сделай сортировку по полям: ФИО, специальность и галочка доступности.

_Изучи `QuerySet API` — API для работы с базой данных._

В файле `doctors.html` опиши блок для сортировки и фильтрации, а во `views.py` опиши их логику.

### Задание 5. Подробная информация о враче
Помнишь, что на карточке врача есть кнопка перехода на детальную информацию? Сделай страничку для каждого:
- Добавь шаблон отображения подробной информации о докторе (`doctor_info.html`).
- В шаблоне отобрази всю информацию из БД о враче.
- Сделай роут `/doctors/<doc_id>`, по которому будет отображаться этот шаблон.
- Сделай так, чтобы при нажатии на кнопку перехода на детальную информацию новая страница открывалась в новом окне.

_Маленькая подсказка про роуты: роут (маршрут) — это путь в приложении, который обрабатывает определенный URL-адрес. В Django роуты описываются в файле `urls.py`. Помнишь, как ты уже создавал маршрут для адреса `/doctors`? Теперь надо сделать похожий, но с динамическим параметром — идентификатором доктора. В Django это можно сделать с помощью конструкции типа `path('doctors/<uuid:doc_id>/', views.doctor_info, name='doctor_info')`. Затем этот параметр `doc_id` будет доступен в соответствующей view-функции._

Здесь ты будешь работать в файле `doctor_info.html`, который лежит в директории `templates/`, отредактируешь `settings.py`, `views.py` и `urls.py`.

### Задание 6. Пагинация
1. Сделай для `doctors/` пагинацию — вывод по `N` на странице (выбирается пользователем, позволяемые значения: 1, 3, 5, 10).

А что такое пагинация? Представь, что в твоей базе данных 100 врачей. Показывать их всех на одной странице — не лучшая идея. Это долго грузится и неудобно для пользователя (прокручивать огромный список — то еще удовольствие). Поэтому данные разбивают на страницы — это и называется пагинацией. Например, 10 врачей на одной странице, еще 10 на второй и так далее. Между страницами пользователь переключается с помощью специальных элементов навигации, обычно это кнопки с номерами страниц или стрелочки «вперед/назад».

В Django есть встроенный механизм пагинации через класс `Paginator`. Тебе нужно будет самостоятельно изучить, как он работает, в документации Django. Основная идея заключается в том, чтобы разбить полученный QuerySet на страницы, получить нужную страницу и передать ее в шаблон. Также не забудь реализовать переключатель размера страницы (1, 3, 5 или 10 элементов).

Для разработки пагинации опиши ее логику во `views.py`, а в шаблоне `doctors.html` опиши набор кнопок для перемещения по страницам.


### Задание 7. Экспорт в файл
1. Сделай новый роут (`doctors/export`).
2. Добавь логику выгрузки данных о врачах в формате `CSV` и `JSON`.

Нужно будет добавить новые маршруты в `urls.py`, реализовать логику во `views.py`, а в шаблоне `doctors.html` добавить две кнопки для экспорта.

### Бонусное задание 8. Импорт из файла
1. Сделай новый роут (`doctors/import`).
2. Добавь логику чтения данных из файла форматов `CSV` и `JSON` и добавления этих данных в БД.
3. Проверь, что данные, которые были экспортированы в предыдущем пункте, могут быть добавлены. Сценарий тестирования:
  - В БД содержится несколько врачей.
  - Производится экспорт в одном из форматов при помощи `doctors/export`.
  - Из БД удаляются все данные.
  - Производится импорт в одном из форматов при помощи `doctors/import`.
  - Ожидаемый результат: записи обо всех врачах снова доступны в БД и на странице `/doctors`.

 **Требования к CSV-файлу:**
 - Файл должен содержать заголовок с названиями полей: `doctor_id,fio,available,specialty`.
 - Значения полей должны быть разделены запятыми.
 - Поле `doctor_id` должно содержать валидный UUID.
 - Поле `available` должно содержать значение `True` или `False`.
 - Пример корректной строки: `f47ac10b-58cc-4372-a567-0e02b2c3d479,Иванов Иван Иванович,True,Терапевт`.

 **Требования к JSON-файлу:**
 - Файл должен содержать массив объектов.
 - Каждый объект должен иметь поля: `doctor_id`, `fio`, `available`, `specialty`.
 - Поле `doctor_id` должно содержать валидный UUID.
 - Поле `available` должно быть логическим типом (boolean).
 - Пример корректного объекта: `{"doctor_id": "f47ac10b-58cc-4372-a567-0e02b2c3d479", "fio": "Иванов Иван Иванович", "available": true, "specialty": "Терапевт"}`.

 _Не забудь реализовать валидацию входных данных! Если формат файла некорректен, пользователь должен получить понятное сообщение об ошибке._

Нужно будет добавить новые маршруты в `urls.py`, добавить шаблон `doctors_import.html` с формой загрузки файла. Во `views.py` опиши логику для обработки этих данных. На шаблон `doctors.html` добавь кнопку для импорта.

Теперь твое веб-приложение умеет достаточно много — и сортировку применять, и фильтрацию. Пагинация тоже тут! А еще теперь у тебя получается редактировать информацию через форму или удалять информацию из БД по клику кнопки веб-приложения! А если справился с экспортом и импортом — то ты вообще супермолодец!

---

Ты с облегчением выдохнул. И понадеялся, что сегодня за тобой никто не следит, потому что ты закончил пораньше и собирался отправиться домой. Так и произошло: ты спокойно собрал вещи, выключил компьютер, для проформы помахал в камеру и ушел. 

Только на улице тебя догнало оповещение о входящей СМС. Только вот оказалась она не от Главврача. 

>Просто хотели поделиться: мы выиграли конкурс по сбору макулатуры! Надеюсь, что завтра посмотрим, как прикручена БД к веб-приложению. Спасибо за ваш тяжелый труд!
>>**Вениамин**

К СМС была приложена фотография: на ней Вениамин и Кларисса обнимали мальчика с грамотой в руках. Мальчик был ужасно похож на обоих сооснователей «Здоровый дух». Но не это привлекло твое внимание: ты приблизил фотографию и на заднем плане увидел... Главврача, который что-то записывал, склонившись над коробками с макулатурой. Что он там забыл?? И как он связан со «Здоровым духом»?

💡 [Нажми сюда](https://oprosso.ru/p/ad3bc98eb2a54c0baf4679fa722b54df), **чтобы поделиться с нами обратной связью на этот проект**. Это анонимно и поможет команде Продукта сделать твое обучение лучше.